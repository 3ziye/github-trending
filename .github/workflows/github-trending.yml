name: GitHub Trending Report (Docker)
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©ä¸‹åˆ2ç‚¹ï¼ˆUTC+8 â†’ UTC 6ç‚¹ï¼ŒæŒ‰å®é™…æ—¶åŒºè°ƒæ•´ï¼‰
  schedule:
    - cron: '0 6 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  run-with-docker:
    runs-on: ubuntu-latest  # Docker ä¾èµ– Linux ç¯å¢ƒ
    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆå« Dockerfile å’Œæ‰€æœ‰è„šæœ¬ï¼‰
      ###########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ###########################################################################
      # æ­¥éª¤2ï¼šæ„å»º Docker é•œåƒï¼ˆåŸºäºä»“åº“å†…çš„ Dockerfileï¼‰
      ###########################################################################
      - name: Build Docker image
        run: |
          # æ„å»ºé•œåƒï¼Œå‘½åä¸º github-trending:latestï¼Œä¸Šä¸‹æ–‡ä¸ºå½“å‰ä»“åº“æ ¹ç›®å½•
          docker build -t github-trending:latest . \
            --label "built-at=$(date +%Y%m%d_%H%M%S)"  # é™„åŠ æ„å»ºæ—¶é—´æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰

      ###########################################################################
      # æ­¥éª¤3ï¼šè¿è¡Œ Docker å®¹å™¨ï¼Œæ‰§è¡Œè„šæœ¬å¹¶æŒ‚è½½æ•°æ®å·ï¼ˆç•™å­˜æŠ¥å‘Š/æ•°æ®ï¼‰
      ###########################################################################
      - name: Run script in Docker container
        env:
          # ä¼ é€’ GitHub Tokenï¼ˆè‹¥è„šæœ¬éœ€è¦ï¼Œéœ€å…ˆåœ¨ä»“åº“ Secrets ä¸­é…ç½® GITHUB_TOKENï¼‰
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ›å»ºæœ¬åœ°ç›®å½•ï¼ˆç”¨äºæŒ‚è½½åˆ°å®¹å™¨ï¼Œç•™å­˜ç”Ÿæˆçš„æŠ¥å‘Š/æ•°æ®ï¼‰
          mkdir -p ./local-data ./local-reports ./local-logs
          chmod -R 777 ./local-data ./local-reports ./local-logs

          echo $GITHUB_TOKEN  # è°ƒè¯•è¾“å‡ºï¼Œç¡®è®¤ç¯å¢ƒå˜é‡ä¼ é€’æˆåŠŸ
          
          # è¿è¡Œå®¹å™¨ï¼š
          docker run --rm -v "./local-data:/app/data" -v "./local-reports:/app/reports" -v "./local-logs:/app/logs" github-trending bash -c "./run_github_trending.sh --time-range daily --count 20"

      ###########################################################################
      # æ­¥éª¤4ï¼šå°†å®¹å™¨ç”Ÿæˆçš„æŠ¥å‘Š/æ•°æ®æäº¤å›ä»“åº“ï¼ˆå¯é€‰ï¼‰
      ###########################################################################
      - name: Commit and push results to repo
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          echo "=== æ£€æŸ¥ local-data ç›®å½•å†…å®¹ ==="
          ls -la ./local-data/
          echo "=== æ£€æŸ¥ local-reports ç›®å½•å†…å®¹ ==="
          ls -la ./local-reports/
          echo "=== æ£€æŸ¥ local-logs ç›®å½•å†…å®¹ ==="
          ls -la ./local-logs/
          
          # å°†æŒ‚è½½ç›®å½•çš„ç»“æœå¤åˆ¶åˆ°ä»“åº“åŸè·¯å¾„ï¼ˆè‹¥è„šæœ¬ä¾èµ–å›ºå®šè·¯å¾„ï¼‰
          mkdir ./data
          mkdir ./reports
          mkdir ./logs
          
          cp -r ./local-data/* ./data/
          cp -r ./local-reports/* ./reports/
          cp -r ./local-logs/* ./logs/
          
          # æ£€æŸ¥å˜æ›´å¹¶æäº¤
          git add ./data/ ./reports/ ./logs/
          git commit -m "ğŸ“Š Update GitHub Trending Report (Docker) $(date +%Y-%m-%d)"
          git push origin main  # è‹¥åˆ†æ”¯æ˜¯ masterï¼Œæ”¹ä¸º git push origin master
