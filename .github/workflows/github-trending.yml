name: GitHub Trending Report (Docker)

on:
  # 定时任务
  schedule:
    # 每 30 分钟执行一次
    - cron: "*/30 * * * *"
    # 每天上海时间 10:10（UTC 02:10）
    - cron: "10 2 * * *"
  # 手动触发（方便测试）
  workflow_dispatch:

permissions:
  contents: write   # 允许推送到仓库

jobs:
  run-with-docker:
    runs-on: ubuntu-latest  # Docker 依赖 Linux 环境
    steps:
      ###########################################################################
      # 步骤1：拉取仓库代码
      ###########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ###########################################################################
      # 步骤2：构建 Docker 镜像
      ###########################################################################
      - name: Build Docker image
        run: |
          docker build -t github-trending:latest . \
            --label "built-at=$(date +%Y%m%d_%H%M%S)"

      ###########################################################################
      # 步骤3：运行 Docker 容器，执行脚本
      ###########################################################################
      - name: Run script in Docker container
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./local-data ./local-reports ./local-logs
          chmod -R 777 ./local-data ./local-reports ./local-logs
          echo "GITHUB_TOKEN=$GITHUB_TOKEN"

          docker run --rm \
            -v "$(pwd)/local-data:/app/data" \
            -v "$(pwd)/local-reports:/app/reports" \
            -v "$(pwd)/local-logs:/app/logs" \
            -e GITHUB_TOKEN=$GITHUB_TOKEN \
            github-trending:latest \
            bash -c "./run_github_trending.sh --time-range daily --count 20"

      ###########################################################################
      # 步骤4：提交结果回仓库
      ###########################################################################
      - name: Commit and push results to repo
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          echo "=== 检查 local-data ==="
          ls -la ./local-data/ || true
          echo "=== 检查 local-reports ==="
          ls -la ./local-reports/ || true
          echo "=== 检查 local-logs ==="
          ls -la ./local-logs/ || true

          mkdir -p ./data ./reports ./logs
          cp -r ./local-data/* ./data/ || true
          cp -r ./local-reports/* ./reports/ || true
          cp -r ./local-logs/* ./logs/ || true

          git add ./data/ ./reports/ ./logs/
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "📊 Update GitHub Trending Report (Docker) $(date +%Y-%m-%d)"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          fi
