name: GitHub Trending Report (Docker)

on:
  # å®šæ—¶ä»»åŠ¡
  schedule:
    # æ¯ 30 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    - cron: "*/30 * * * *"
    # æ¯å¤©ä¸Šæµ·æ—¶é—´ 10:10ï¼ˆUTC 02:10ï¼‰
    - cron: "10 2 * * *"
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

permissions:
  contents: write   # å…è®¸æ¨é€åˆ°ä»“åº“

jobs:
  run-with-docker:
    runs-on: ubuntu-latest  # Docker ä¾èµ– Linux ç¯å¢ƒ
    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      ###########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ###########################################################################
      # æ­¥éª¤2ï¼šæ„å»º Docker é•œåƒ
      ###########################################################################
      - name: Build Docker image
        run: |
          docker build -t github-trending:latest . \
            --label "built-at=$(date +%Y%m%d_%H%M%S)"

      ###########################################################################
      # æ­¥éª¤3ï¼šè¿è¡Œ Docker å®¹å™¨ï¼Œæ‰§è¡Œè„šæœ¬
      ###########################################################################
      - name: Run script in Docker container
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./local-data ./local-reports ./local-logs
          chmod -R 777 ./local-data ./local-reports ./local-logs
          echo "GITHUB_TOKEN=$GITHUB_TOKEN"

          docker run --rm \
            -v "$(pwd)/local-data:/app/data" \
            -v "$(pwd)/local-reports:/app/reports" \
            -v "$(pwd)/local-logs:/app/logs" \
            -e GITHUB_TOKEN=$GITHUB_TOKEN \
            github-trending:latest \
            bash -c "./run_github_trending.sh --time-range daily --count 20"

      ###########################################################################
      # æ­¥éª¤4ï¼šæäº¤ç»“æœå›ä»“åº“
      ###########################################################################
      - name: Commit and push results to repo
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          echo "=== æ£€æŸ¥ local-data ==="
          ls -la ./local-data/ || true
          echo "=== æ£€æŸ¥ local-reports ==="
          ls -la ./local-reports/ || true
          echo "=== æ£€æŸ¥ local-logs ==="
          ls -la ./local-logs/ || true

          mkdir -p ./data ./reports ./logs
          cp -r ./local-data/* ./data/ || true
          cp -r ./local-reports/* ./reports/ || true
          cp -r ./local-logs/* ./logs/ || true

          git add ./data/ ./reports/ ./logs/
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“Š Update GitHub Trending Report (Docker) $(date +%Y-%m-%d)"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          fi
